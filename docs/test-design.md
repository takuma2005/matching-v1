# テスト設計ドキュメント（Jest）

## 1. プロジェクト解析サマリ

- **アーキテクチャ概要**: Expo/React Native 構成で、`App.tsx` から `RoleBasedNavigator` を経由し、`AuthContext`・`UserContext`・`FavoritesContext` などのコンテキストが全画面に状態を供給する。
- **ドメイン層**: コイン管理ドメインは `src/domain/coin` にまとまり、ゲートウェイを `MockCoinGateway`/`ProdCoinGateway` で切り替え、`CoinManager` がイベントエミッタと併せて残高を同期する。
- **サービス層**: `src/services/api/mock` 配下に Supabase を模したモック API 群（認証、マッチング、コイン、通知、チャット等）があり、`mockDb` によって疑似的なデータベース状態を保持する。
- **UI/ユーティリティ層**: `src/utils/validation.ts` には Zod を用いたバリデーション、`src/constants/coinPlans.ts` にはコイン料金テーブルと換算ユーティリティが定義されている。
- **既存テスト**: 既存 Jest テストはモックサービスの基本的な動作検証のみで、境界値・異常系・イベント通知・UI レイヤーの動作が未カバーだったため、本ドキュメントに従い網羅的なケースを設計・実装する。

## 2. 単体テスト（Jest）設計

各ケースでは正常系/異常系/境界値/分岐/例外処理を明示し、`mockDb` を用いたモックでデータベース依存を排除する。

### 2.1 `src/utils/validation.ts`

| ケースID | 観点                             | 入力条件                             | 期待結果                                    | 分類      |
| -------- | -------------------------------- | ------------------------------------ | ------------------------------------------- | --------- |
| V-01     | 時給バリデーション下限           | `rate = MIN_HOURLY_RATE - 1`         | `success=false`・エラー文に下限値が含まれる | 境界/異常 |
| V-02     | 時給バリデーション下限値         | `rate = MIN_HOURLY_RATE`             | `success=true`・同じ値を返却                | 境界/正常 |
| V-03     | 時給バリデーション上限超え       | `rate = 50001`                       | 上限超過メッセージを返す                    | 境界/異常 |
| V-04     | 先輩プロフィール正常             | 必須値/科目1件/下限以上の時給        | `success=true`                              | 正常      |
| V-05     | 先輩プロフィール異常一括検知     | 必須値欠落・時給下限未満・科目空配列 | `errors` に各キー                           | 異常/分岐 |
| V-06     | 学生プロフィール正常             | 必須値・興味科目あり                 | `success=true`                              | 正常      |
| V-07     | 学生プロフィール異常             | 必須値欠落・科目空配列               | 各フィールドエラー                          | 異常      |
| V-08     | リアルタイムバリデーション空文字 | `""`                                 | `null` を返す                               | 正常      |
| V-09     | リアルタイム数値化失敗           | `'abc'`                              | `'数値を入力してください'`                  | 異常      |
| V-10     | リアルタイム下限未満             | `MIN_HOURLY_RATE - 50`               | 下限メッセージ                              | 境界/異常 |
| V-11     | リアルタイム下限以上             | `MIN_HOURLY_RATE + 200`              | `null`                                      | 境界/正常 |
| V-12     | 表示フォーマット正常             | `rate = MIN_HOURLY_RATE`             | `coinText`/`yenText`/`isValid=true`         | 正常      |
| V-13     | 表示フォーマット異常             | `rate = MIN_HOURLY_RATE - 100`       | `isValid=false`                             | 異常      |
| V-14     | パッケージお得度計算             | 代表プラン                           | `basePrice`/`savings`/`percent` が期待値    | 分岐      |

### 2.2 `src/services/api/mock/coinService.ts`

| ケースID | 観点                    | 入力条件                             | 期待結果                              | 分類      |
| -------- | ----------------------- | ------------------------------------ | ------------------------------------- | --------- |
| C-01     | 残高取得成功            | 既存生徒ID                           | `success=true`・残高一致              | 正常      |
| C-02     | 残高取得失敗            | 不明ID                               | `success=false`・エラーメッセージ     | 異常      |
| C-03     | コイン購入成功          | `amount>0`・有効PM                   | 残高加算・取引追加・`type=purchase`   | 正常/分岐 |
| C-04     | コイン購入金額ゼロ      | `amount=0`                           | `success=false`・残高/台帳変化なし    | 境界/異常 |
| C-05     | コイン購入ユーザー不在  | 不明ID                               | `success=false`・台帳変化なし         | 異常      |
| C-06     | カード拒否シナリオ      | `paymentMethodId = pm_card_declined` | `success=false`・残高変化なし         | 異常/分岐 |
| C-07     | 取引履歴フィルタ/並び順 | 既存ID・`page=1, limit=2`            | 同ユーザーのみ・降順・`has_more=true` | 分岐      |
| C-08     | モック取引追加          | `addMockTransaction`                 | 残高更新・台帳末尾に追記              | 正常      |

### 2.3 `src/domain/coin/coinManager.ts`

| ケースID | 観点             | 入力条件                                             | 期待結果                                 | 分類      |
| -------- | ---------------- | ---------------------------------------------------- | ---------------------------------------- | --------- |
| M-01     | 残高同期イベント | `syncBalance(student-1)`                             | 取得値を返却し `coinEvents` が発火       | 正常/分岐 |
| M-02     | 購入イベント連動 | `purchase(amount=300)`                               | 残高加算・イベント通知                   | 正常      |
| M-03     | 減算デルタ適用   | `applyDelta(amount=-MATCHING_COST, reason='lesson')` | 残高減算・取引`type=spend`・イベント通知 | 分岐      |
| M-04     | ボーナス付与     | `applyDelta(amount=120, reason='bonus')`             | 自動説明文 `ボーナス付与` 付与           | 正常/分岐 |

### 2.4 `src/services/api/mock/matchingService.ts`

| ケースID | 観点             | 入力条件                                       | 期待結果                                          | 分類      |
| -------- | ---------------- | ---------------------------------------------- | ------------------------------------------------- | --------- |
| MS-01    | 申請成功         | 正常メッセージ・十分なコイン                   | `pending` 登録・コイン減算・通知1件               | 正常      |
| MS-02    | メッセージ短すぎ | 20文字未満                                     | `success=false`・エラーテキスト                   | 境界/異常 |
| MS-03    | コイン不足       | 残高 < 300                                     | `success=false`・残高不変                         | 異常      |
| MS-04    | 先輩不在         | 不明 tutorId                                   | `success=false`                                   | 異常      |
| MS-05    | 重複申請         | 同学生/先輩で pending あり                     | `success=false`・重複エラー                       | 分岐/異常 |
| MS-06    | 期限切れ自動遷移 | `getStudentMatchRequests` で `expires_at` 過去 | ステータス `expired` に更新                       | 分岐/例外 |
| MS-07    | 承認処理         | `approveMatchRequest`                          | `status=approved`・チャット生成・通知（学生向け） | 正常/分岐 |
| MS-08    | 拒否処理         | `rejectMatchRequest`                           | ステータス `rejected`・コイン返金・通知2件        | 異常分岐  |
| MS-09    | キャンセル処理   | `cancelMatchRequest`                           | ステータス `cancelled`・返金・通知2件             | 分岐      |

### 2.5 `src/services/api/mock/notificationService.ts`

| ケースID | 観点       | 入力条件                | 期待結果                              | 分類 |
| -------- | ---------- | ----------------------- | ------------------------------------- | ---- |
| N-01     | 通知作成   | 任意ユーザー            | 台帳末尾に追加・戻り値 `success=true` | 正常 |
| N-02     | 最新順取得 | 同ユーザー3件 + limit=2 | 降順ソート・2件返却                   | 分岐 |
| N-03     | 既読化成功 | 既存ID                  | `is_read=true`・戻り値に反映          | 正常 |
| N-04     | 既読化失敗 | 不明ID                  | `success=false`・エラーメッセージ     | 異常 |
| N-05     | 全件既読   | ユーザー未読2件         | `data=2`・全件既読化                  | 分岐 |
| N-06     | 未読件数   | 1件既読済み             | `data=1`                              | 分岐 |

## 3. E2E テスト方針（参考）

- 現行の開発環境では Playwright を用いたブラウザ自動テストを実行できないため、当面は Jest によるユニット/サービス層テストで品質を担保する。
- UI フローの確認は Expo Go などを利用した手動テストで代替し、シナリオ・期待結果は別途 QA シートで管理する。
- 将来的に E2E 自動化を再開する場合は、本ドキュメントのユニットテスト観点を流用し、フォームバリデーションとモック API の整合性を重点的に検証する。

## 4. モック／データリセット戦略

- **環境変数固定**: Jest セットアップで `EXPO_PUBLIC_API_MODE='mock'`・`EXPO_PUBLIC_USE_MOCK='true'` を強制し、本番ゲートウェイ呼び出しを抑止。
- **モック DB 再初期化**: `jest.resetModules()` で各ケースごとに `mockDb` を再読み込みし、副作用が次ケースへ伝播しないようにする。
- **時間待ちの短縮**: `jest.useFakeTimers()` を利用し、`delay` による待機を即時解決してテスト時間を短縮する。
- **副作用検証**: 取引台帳、通知配列、チャットルーム生成など副作用のある機能は必ず事後状態を検証し、未読件数やイベント通知などの観点を含めた。

本設計に基づき、Jest の正常系・異常系・境界値・分岐・例外処理を網羅するテストを実装する。
